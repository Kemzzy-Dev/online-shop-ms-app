pipeline {
  agent {
    label 'node1'
  }

  environment {
    IMAGE_NAME = "checkoutservice"
    IMAGE_TAG = "latest"
    TRIVY_OUTPUT = "trivy-scan-report.txt"
    DOCKERHUB_USERNAME = "kemzzy"
  }


  stages {

    stage('Checkout code') {
      // Monitors the checkoutservice folder for change and triggers the pipeline
      when {
        changeset "src/checkoutservice/**"
      }

      steps {
        git branch: 'main', url: 'https://github.com/Kemzzy-Dev/online-shop-ms-app'
      }
    }
    
    stage('Scan code with Sonarqube') {
      environment {
        scannerHome = tool 'sonarqubescanner';
      }
      steps {
        withSonarQubeEnv(credentialsId: 'sonarqube', installationName: 'SonarQubeServer') {
          dir('src/checkoutservice') {
            sh "${scannerHome}/bin/sonar-scanner"
          }
        }
      }
    }

    stage('Build Docker image') {
      steps {
        script {
          def image = docker.build("${IMAGE_NAME}:${IMAGE_TAG}")
        }
      }
    }

    stage('Scan Docker Image with Trivy') {
      steps {
        script {
          sh """
          trivy image -f table -o ${TRIVY_OUTPUT} ${IMAGE_NAME}:${IMAGE_TAG}
          """
        }
      }
    }

  //   stage('Push Docker image') {
  //     steps {
  //       script {
  //         docker.withRegistry('https://registry.hub.docker.com', '${DOCKERHUB_USERNAME}') {
  //           image.push('latest')
  //           image.push("${env.BUILD_NUMBER}")
  //           image.push("${env.BUILD_ID}")
  //         }
  //       }
  //     }
  //   }
  // }
  }
}